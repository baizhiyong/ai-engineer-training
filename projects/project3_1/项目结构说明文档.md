# 智能FAQ检索系统 - 项目结构说明文档

## 项目概述

基于 LlamaIndex 和 FAISS 向量数据库构建的智能FAQ检索系统，采用 RAG（Retrieval-Augmented Generation）架构，为用户提供高效、准确的问答服务。系统支持自然语言问题查询、知识库动态管理、多轮对话等功能。

## 技术架构

### 核心技术栈
- **AI框架**: LlamaIndex - 用于构建复杂的对话流程和文档检索
- **向量数据库**: FAISS - 高性能相似度检索
- **嵌入模型**: DashScope Text-Embedding-v3 - 阿里云千问嵌入模型
- **语言模型**: DashScope Qwen-Plus - 阿里云千问大语言模型
- **API框架**: FastAPI - RESTful API 设计
- **Web服务器**: Uvicorn - ASGI服务器

### 系统架构图
```
用户请求 → FastAPI → KnowledgeBaseManager → FAQDataLoader → FAISS索引 → 答案生成 → 响应返回
                    ↓
                知识库管理 → 版本控制 → 数据持久化
```

## 项目目录结构

```
project3_1/
├── .env                        # 环境变量配置文件
├── FAQ.txt                     # FAQ数据源文件
├── 项目描述.txt                # 项目详细描述
├── requirements.txt            # Python依赖包列表
├── config.py                   # 系统配置模块
├── webapi.py                   # FastAPI Web服务主入口
├── kb_manager.py               # 知识库管理器核心模块
├── data_loader.py              # 数据加载和向量化模块
├── ask.py                      # 命令行查询工具
├── train.py                    # 索引构建训练脚本
├── kb_demo.py                  # 知识库演示脚本
├── venv/                       # Python虚拟环境
├── __pycache__/                # Python字节码缓存
└── data/                       # 数据存储目录
    ├── faiss_index/            # FAISS向量索引文件
    │   ├── default__vector_store.json
    │   ├── docstore.json
    │   ├── graph_store.json
    │   ├── image__vector_store.json
    │   └── index_store.json
    ├── backups/                # 知识库备份目录
    │   ├── backup_1.0.1_20251028_050755/
    │   └── backup_1.0.2_20251028_050839/
    ├── version.json            # 版本管理文件
    ├── export_demo.csv         # 导出示例文件
    ├── export_demo.json        # JSON格式导出示例
    ├── export_demo.txt         # 文本格式导出示例
    └── test_import.json        # 测试导入数据
```

## 核心模块详解

### 1. webapi.py - Web API服务
**功能**: FastAPI应用主入口，提供RESTful API接口
**主要特性**:
- 聊天问答接口 (`/api/v1/chat`)
- 知识库管理接口 (`/api/v1/knowledge/faq`)
- 系统健康检查 (`/api/v1/system/health`)
- 批量导入导出功能
- 会话管理和历史记录
- 异常处理和错误响应

**核心API端点**:
```python
GET /docs                           # Swagger UI文档
POST /api/v1/chat                   # 发送问题获取答案
GET /api/v1/chat/history            # 获取对话历史
POST /api/v1/knowledge/faq          # 添加FAQ条目
PUT /api/v1/knowledge/faq/{id}      # 更新FAQ条目
DELETE /api/v1/knowledge/faq/{id}   # 删除FAQ条目
GET /api/v1/knowledge/faq           # 查询FAQ列表
POST /api/v1/knowledge/batch        # 批量导入FAQ
GET /api/v1/system/health           # 系统健康检查
POST /api/v1/system/rebuild-index   # 重建向量索引
```

### 2. kb_manager.py - 知识库管理器
**功能**: 实现知识库的动态管理功能
**主要特性**:
- FAQ条目的增删改查操作
- 批量导入导出功能
- 版本管理和备份机制
- 自动索引重建
- 数据持久化

**核心方法**:
```python
get_all_faqs()                      # 获取所有FAQ
get_faq_by_id(faq_id)              # 根据ID获取FAQ
search_faqs(keyword)                # 关键词搜索FAQ
add_faq(question, answer)           # 添加新FAQ
update_faq(faq_id, question, answer) # 更新FAQ
delete_faq(faq_id)                  # 删除FAQ
rebuild_index(force=True)           # 重建索引
```

### 3. data_loader.py - 数据加载器
**功能**: 处理FAQ数据的加载、向量化和索引构建
**主要特性**:
- FAQ文件解析（支持Q:A:格式）
- 文档向量化处理
- FAISS索引构建和管理
- 索引持久化和加载
- 嵌入模型集成

**核心方法**:
```python
parse_faq_file(file_path)           # 解析FAQ文件
create_documents(faq_items)         # 创建文档对象
build_vector_index(documents)       # 构建向量索引
save_index(index, index_path)       # 保存索引
load_index(index_path)              # 加载索引
initialize_faq_system()             # 初始化FAQ系统
```

### 4. config.py - 配置管理
**功能**: 系统配置参数管理
**主要配置**:
```python
DASHSCOPE_API_KEY                   # 阿里云API密钥
DASHSCOPE_EMBEDDING_MODEL           # 嵌入模型名称
FAISS_INDEX_PATH                    # FAISS索引存储路径
VECTOR_DIMENSION                    # 向量维度(512)
FAQ_FILE_PATH                       # FAQ数据文件路径
TOP_K                               # 检索返回数量(3)
```

## 工作流程说明

### 1. 系统初始化流程
```
1. 加载环境变量配置 (.env)
2. 初始化DashScope嵌入模型和LLM
3. 检查FAISS索引是否存在
4. 如不存在，解析FAQ.txt构建初始索引
5. 启动FastAPI服务器
```

### 2. 问答查询流程
```
用户提问 → API接收请求 → 向量化用户问题 → FAISS相似度检索 → 
获取相关FAQ → LLM生成回答 → 返回结果给用户
```

### 3. 知识库管理流程
```
添加/更新FAQ → 数据验证 → 保存到数据文件 → 重建FAISS索引 → 
创建版本备份 → 更新版本信息
```

### 4. 索引构建流程
```
读取FAQ数据 → 解析Q:A:格式 → 创建Document对象 → 
向量化处理 → 构建FAISS索引 → 持久化存储
```

## 部署和使用指南

### 1. 环境准备
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置设置
```bash
# 复制并编辑环境变量文件
cp .env.example .env
# 设置DASHSCOPE_API_KEY
```

### 3. 初始化系统
```bash
# 构建初始索引
python train.py

# 测试查询功能
python ask.py

# 启动Web服务
python webapi.py
```

### 4. API使用示例
```bash
# 发送问题
curl -X POST "http://localhost:8000/api/v1/chat" \
     -H "Content-Type: application/json" \
     -d '{"question": "如何退货？"}'

# 添加FAQ
curl -X POST "http://localhost:8000/api/v1/knowledge/faq" \
     -H "Content-Type: application/json" \
     -d '{"question": "新问题", "answer": "新答案"}'
```

## 数据格式说明

### FAQ数据格式
```
Q: 问题内容
A: 答案内容

Q: 下一个问题
A: 下一个答案
```

### API请求/响应格式
```json
// 聊天请求
{
  "question": "用户问题",
  "session_id": "可选的会话ID"
}

// 聊天响应
{
  "answer": "系统回答",
  "session_id": "会话ID",
  "sources": [{"question": "相关FAQ问题", "answer": "FAQ答案"}],
  "timestamp": "2024-01-01T12:00:00"
}
```

## 扩展功能

### 已实现功能
- ✅ 基础问答检索
- ✅ FAISS向量存储
- ✅ RESTful API接口
- ✅ 知识库动态管理
- ✅ 版本控制和备份
- ✅ 批量导入导出
- ✅ 会话管理

### 计划扩展功能
- 🔄 多轮对话上下文理解
- 🔄 用户反馈机制
- 🔄 系统监控与日志
- 🔄 多语言支持
- 🔄 权限管理
- 🔄 性能优化

## 系统要求

### 硬件要求
- **CPU**: 2核心以上
- **内存**: 建议4GB以上
- **存储**: 根据知识库大小调整（建议10GB以上）
- **网络**: 支持HTTP/HTTPS协议

### 软件要求
- **Python**: 3.10+
- **操作系统**: Windows/Linux/macOS
- **网络**: 需要访问阿里云DashScope API

## 故障排除

### 常见问题
1. **API密钥错误**: 检查.env文件中的DASHSCOPE_API_KEY设置
2. **索引构建失败**: 确认FAQ.txt文件格式正确
3. **服务启动失败**: 检查端口8000是否被占用
4. **查询无结果**: 确认FAISS索引是否正确构建

### 日志查看
```bash
# 查看服务日志
python webapi.py  # 控制台输出日志

# 检查索引状态
python -c "from data_loader import FAQDataLoader; loader = FAQDataLoader(); print(loader.load_index())"
```

## 开发和维护

### 代码结构
- 遵循Python PEP8编码规范
- 使用类型注解提高代码可读性
- 模块化设计，职责分离
- 完善的错误处理机制

### 测试建议
- 单元测试：测试各模块核心功能
- 集成测试：测试API接口完整性
- 性能测试：测试大量数据下的响应时间
- 压力测试：测试并发访问能力

### 版本管理
- 使用语义化版本号（如1.0.0）
- 自动备份机制保护数据安全
- 版本历史记录便于回滚

---

**项目维护者**: Wilson  
**最后更新**: 2024年10月28日  
**版本**: 1.0.0