# AutoGen 多智能体客服系统 - 项目结构说明文档

## 1. 项目概述

### 1.1 项目简介
本项目是基于 AutoGen 框架构建的多智能体客服系统，旨在通过多个智能体协同工作来处理客户服务问题。系统能够自动处理客户关于订单状态和物流信息的查询，并提供智能化的回复服务。

### 1.2 主要功能
- **订单状态查询**：Agent A 负责查询订单的详细状态信息
- **物流信息检查**：Agent B 负责获取订单的物流跟踪信息
- **结果汇总回复**：Agent C 负责整合信息并生成用户友好的回复
- **自动重试机制**：支持指数级退避的网络请求重试
- **详细交互展示**：实时显示智能体之间的交互过程

### 1.3 技术特点
- 基于 AutoGen 框架的多智能体架构
- 异步处理和并发支持
- 完善的错误处理和重试机制
- 丰富的命令行界面展示
- 模块化设计，易于扩展和维护

### 1.4 主要技术栈

#### 核心框架
- **AutoGen (>=0.2.0)**: 多智能体框架，负责智能体的创建、管理和协调
- **FastAPI (>=0.104.0)**: 现代化的 Web API 框架，用于构建模拟内部系统
- **Uvicorn (>=0.24.0)**: ASGI 服务器，用于运行 FastAPI 应用

#### 数据处理
- **Pydantic (>=2.5.0)**: 数据验证和序列化
- **Pydantic-settings (>=2.1.0)**: 配置管理

#### 异步和网络
- **aiofiles (>=23.2.0)**: 异步文件操作
- **httpx (>=0.25.0)**: 现代化的异步 HTTP 客户端
- **tenacity (>=8.2.0)**: 重试机制库

#### AI 和语言模型
- **OpenAI (>=1.3.0)**: OpenAI API 客户端

#### 用户界面和工具
- **Rich (>=13.7.0)**: 丰富的命令行界面库
- **Colorama (>=0.4.6)**: 跨平台彩色终端输出
- **Python-dotenv (>=1.0.0)**: 环境变量管理

#### 开发和测试
- **Pytest (>=7.4.0)**: 测试框架
- **Pytest-asyncio (>=0.21.0)**: 异步测试支持
- **Black (>=23.11.0)**: 代码格式化工具

## 2. 文件结构说明

```
week1_2/
├── .env.example                 # 环境变量配置示例文件
├── main.py                      # 项目主入口文件 ⭐
├── requirements.txt             # Python 依赖包列表 ⭐
├── 项目描述.txt                 # 项目需求和场景描述
├── 项目结构说明文档.md          # 本文档
├── agents/                      # 智能体模块目录
│   └── autogen_agents.py       # AutoGen 智能体实现 ⭐
├── api/                         # API 服务模块目录
│   └── fastapi_server.py       # FastAPI 模拟服务器 ⭐
├── config/                      # 配置模块目录
│   └── settings.py             # 项目配置管理 ⭐
├── core/                        # 核心功能模块目录
│   └── logger.py               # 日志系统配置 ⭐
├── tools/                       # 工具模块目录
│   └── api_client.py           # API 客户端工具 ⭐
├── utils/                       # 工具函数目录
│   └── retry.py                # 重试机制实现 ⭐
├── logs/                        # 日志文件目录
│   └── app.log                 # 应用日志文件
└── venv/                        # Python 虚拟环境目录
    ├── Include/                # 头文件目录
    ├── Lib/                    # 库文件目录
    ├── Scripts/                # 可执行文件目录
    ├── pyvenv.cfg              # 虚拟环境配置
    └── share/                  # 共享文件目录
```

### 2.1 关键文件详细说明

#### 🔥 核心入口文件
- **`main.py`**: 项目主入口，负责启动服务、解析命令行参数、协调各模块工作
  - 支持命令行参数解析
  - 启动 FastAPI 模拟服务
  - 初始化 AutoGen 智能体
  - 处理用户查询请求

#### 🤖 智能体模块
- **`agents/autogen_agents.py`**: AutoGen 智能体核心实现
  - 定义三个专门的智能体（订单查询、物流查询、结果汇总）
  - 实现智能体间的通信协议
  - 提供交互过程的可视化展示
  - 集成 API 调用功能

#### 🌐 API 服务模块
- **`api/fastapi_server.py`**: 模拟内部系统的 REST API 服务
  - 提供订单状态查询接口 (`/api/orders/{order_id}`)
  - 提供物流信息查询接口 (`/api/logistics/{order_id}`)
  - 包含模拟数据和错误处理
  - 支持 CORS 跨域请求

#### ⚙️ 配置和核心模块
- **`config/settings.py`**: 统一的配置管理
  - OpenAI API 配置
  - 重试机制参数
  - 日志系统配置
  - 模拟服务配置
  - 智能体行为配置

- **`core/logger.py`**: 日志系统实现
  - 支持文件和控制台双重输出
  - UTF-8 编码支持
  - 日志轮转功能
  - 统一的日志格式

#### 🔧 工具模块
- **`tools/api_client.py`**: API 客户端封装
  - 封装 HTTP 请求逻辑
  - 集成重试机制
  - 提供友好的错误处理
  - 支持异步操作

- **`utils/retry.py`**: 重试机制实现
  - 基于 tenacity 库的指数退避重试
  - 可配置的重试策略
  - HTTP 错误智能判断
  - 详细的重试日志

#### 📋 配置文件
- **`.env.example`**: 环境变量配置模板
- **`requirements.txt`**: Python 依赖包清单
- **`项目描述.txt`**: 项目需求和技术难点说明

## 3. 运行说明

### 3.1 环境配置要求

#### 系统要求
- **操作系统**: Windows 10/11, macOS 10.14+, Linux (Ubuntu 18.04+)
- **Python 版本**: Python 3.9 或更高版本
- **内存**: 至少 4GB RAM
- **磁盘空间**: 至少 2GB 可用空间

#### 必需的外部服务
- **OpenAI API**: 需要有效的 OpenAI API 密钥（可选，用于智能体对话）
- **网络连接**: 用于 API 调用和依赖包下载

### 3.2 安装依赖步骤

#### 步骤 1: 克隆或下载项目
```bash
# 如果从 Git 仓库克隆
git clone <repository-url>
cd week1_2

# 或直接进入项目目录
cd d:\AI工程化训练营\workspace\project\project1_2
```

#### 步骤 2: 创建虚拟环境（推荐）
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

#### 步骤 3: 安装依赖包
```bash
# 升级 pip
python -m pip install --upgrade pip

# 安装项目依赖
pip install -r requirements.txt
```

#### 步骤 4: 配置环境变量
```bash
# 复制环境变量模板
copy .env.example .env  # Windows
cp .env.example .env    # macOS/Linux

# 编辑 .env 文件，填入必要的配置
# 特别是 OPENAI_API_KEY（如果使用 OpenAI 服务）
```

### 3.3 项目启动和运行

#### 方式 1: 直接运行主程序
```bash
# 基本运行（使用默认查询）
python main.py

# 指定查询内容
python main.py --query "我的订单ORD001为什么还没发货？"

# 查看帮助信息
python main.py --help
```

#### 方式 2: 分步启动（开发调试用）
```bash
# 终端 1: 启动 FastAPI 模拟服务
python api/fastapi_server.py

# 终端 2: 运行智能体系统
python main.py --query "我的订单ORD002的物流状态如何？"
```

#### 方式 3: 交互式运行
```bash
# 启动后会提示输入查询
python main.py --interactive
```

### 3.4 测试和构建流程

#### 运行单元测试
```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_agents.py

# 运行测试并显示覆盖率
pytest --cov=. --cov-report=html
```

#### 代码质量检查
```bash
# 代码格式化
black .

# 代码风格检查
flake8 .

# 类型检查（如果配置了 mypy）
mypy .
```

#### 构建和打包
```bash
# 生成依赖包列表
pip freeze > requirements.txt

# 创建分发包（如果需要）
python setup.py sdist bdist_wheel
```

### 3.5 常用命令示例

```bash
# 查询特定订单
python main.py --query "订单ORD001的状态如何？"

# 查询物流信息
python main.py --query "我的订单ORD002什么时候能到？"

# 启用详细日志
python main.py --query "订单查询" --log-level DEBUG

# 测试 API 连接
python -c "from tools.api_client import api_client; import asyncio; asyncio.run(api_client.health_check())"
```

## 4. 数据流说明

### 4.1 整体数据流架构

```
用户查询 → 主程序 → AutoGen智能体系统 → API客户端 → FastAPI服务 → 返回结果
    ↓           ↓            ↓              ↓           ↓
  命令行     main.py    agents/autogen_    tools/     api/
  参数                  agents.py       api_client   fastapi_server
                                         .py          .py
```

### 4.2 详细数据流程

#### 阶段 1: 请求初始化
1. **用户输入**: 通过命令行传入查询字符串
2. **参数解析**: `main.py` 解析命令行参数和查询内容
3. **服务启动**: 启动 FastAPI 模拟服务（如果未运行）
4. **智能体初始化**: 创建三个专门的 AutoGen 智能体

#### 阶段 2: 智能体协作处理
1. **查询分发**: 主程序将用户查询发送给 AutoGen 群组聊天管理器
2. **任务分解**: 智能体系统自动识别需要执行的任务类型
3. **并行处理**:
   - **Agent A (订单查询智能体)**: 
     - 从查询中提取订单ID
     - 调用 `api_client.get_order_status(order_id)`
     - 返回订单状态信息
   - **Agent B (物流查询智能体)**:
     - 使用相同的订单ID
     - 调用 `api_client.get_logistics_info(order_id)`
     - 返回物流跟踪信息
4. **结果汇总**: Agent C 收集前两个智能体的结果，生成用户友好的回复

#### 阶段 3: API 调用和数据获取
1. **HTTP 请求**: API 客户端向 FastAPI 服务发送 HTTP 请求
2. **重试机制**: 如果请求失败，自动执行指数退避重试
3. **数据解析**: 将 JSON 响应解析为 Python 字典
4. **错误处理**: 处理网络错误、超时、404等异常情况

#### 阶段 4: 结果返回和展示
1. **数据整合**: 将订单和物流信息整合为完整的回复
2. **格式化输出**: 使用 Rich 库创建美观的命令行界面展示
3. **日志记录**: 记录整个处理过程的详细日志
4. **用户反馈**: 向用户展示最终的查询结果

### 4.3 主要模块间的交互方式

#### AutoGen 智能体通信协议
```python
# 智能体间的消息传递格式
{
    "role": "user|assistant|system",
    "content": "消息内容",
    "name": "智能体名称",
    "function_call": {
        "name": "函数名",
        "arguments": "参数"
    }
}
```

#### API 调用接口规范
```python
# 订单查询接口
GET /api/orders/{order_id}
Response: {
    "order_id": "ORD001",
    "status": "processing|shipped|delivered",
    "customer_name": "客户姓名",
    "total_amount": 299.99,
    "items": ["商品列表"],
    "shipping_address": "配送地址",
    "created_at": "创建时间",
    "updated_at": "更新时间",
    "estimated_delivery": "预计送达时间"
}

# 物流查询接口
GET /api/logistics/{order_id}
Response: {
    "order_id": "ORD001",
    "tracking_number": "快递单号",
    "status": "not_shipped|in_transit|out_for_delivery|delivered",
    "current_location": "当前位置",
    "carrier": "承运商",
    "estimated_delivery": "预计送达时间",
    "tracking_history": [
        {
            "time": "时间",
            "location": "地点",
            "status": "状态"
        }
    ]
}
```

### 4.4 关键API调用和数据转换

#### 重试机制实现
```python
@create_retry_decorator(max_attempts=3, min_wait=1.0, max_wait=10.0)
async def api_call():
    # 指数退避: 1s → 2s → 4s → 8s
    # 最大等待时间: 10s
    # 最大重试次数: 3次
```

#### 数据转换流程
1. **原始查询** → **订单ID提取** → **API调用参数**
2. **JSON响应** → **Python字典** → **智能体消息格式**
3. **多个API结果** → **整合数据** → **用户友好文本**

#### 异步处理机制
- 使用 `asyncio` 实现并发API调用
- 智能体可以并行处理不同的任务
- 非阻塞的用户界面更新

## 5. 其他必要内容

### 5.1 项目部署说明

#### 开发环境部署
1. **本地开发**:
   ```bash
   # 克隆项目
   git clone <repository>
   cd week1_2
   
   # 安装依赖
   pip install -r requirements.txt
   
   # 配置环境变量
   cp .env.example .env
   
   # 运行项目
   python main.py
   ```

2. **Docker 部署**（推荐用于生产环境）:
   ```dockerfile
   # Dockerfile 示例
   FROM python:3.9-slim
   WORKDIR /app
   COPY requirements.txt .
   RUN pip install -r requirements.txt
   COPY . .
   CMD ["python", "main.py"]
   ```

#### 生产环境部署
1. **服务器要求**:
   - CPU: 2核心以上
   - 内存: 4GB以上
   - 存储: 10GB以上
   - 网络: 稳定的互联网连接

2. **环境配置**:
   ```bash
   # 安装系统依赖
   sudo apt-get update
   sudo apt-get install python3 python3-pip
   
   # 创建服务用户
   sudo useradd -m -s /bin/bash autogen-service
   
   # 部署应用
   sudo -u autogen-service git clone <repository>
   cd /home/autogen-service/week1_2
   sudo -u autogen-service pip install -r requirements.txt
   ```

3. **系统服务配置**:
   ```ini
   # /etc/systemd/system/autogen-service.service
   [Unit]
   Description=AutoGen Multi-Agent Customer Service
   After=network.target
   
   [Service]
   Type=simple
   User=autogen-service
   WorkingDirectory=/home/autogen-service/week1_2
   ExecStart=/usr/bin/python3 main.py
   Restart=always
   
   [Install]
   WantedBy=multi-user.target
   ```

### 5.2 常见问题解决方案

#### Q1: OpenAI API 连接失败
**问题**: `openai.error.AuthenticationError: Invalid API key`
**解决方案**:
1. 检查 `.env` 文件中的 `OPENAI_API_KEY` 是否正确
2. 确认 API 密钥有足够的配额
3. 检查网络连接和防火墙设置
4. 尝试使用代理服务器

#### Q2: FastAPI 服务启动失败
**问题**: `OSError: [Errno 98] Address already in use`
**解决方案**:
1. 检查端口 8000 是否被占用: `netstat -tulpn | grep 8000`
2. 终止占用端口的进程: `kill -9 <PID>`
3. 修改配置文件中的端口号
4. 使用不同的端口启动服务

#### Q3: 依赖包安装失败
**问题**: `pip install` 过程中出现编译错误
**解决方案**:
1. 升级 pip: `python -m pip install --upgrade pip`
2. 安装系统依赖: `sudo apt-get install python3-dev build-essential`
3. 使用预编译包: `pip install --only-binary=all <package>`
4. 使用国内镜像源: `pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/`

#### Q4: 智能体响应缓慢
**问题**: AutoGen 智能体处理时间过长
**解决方案**:
1. 检查网络连接质量
2. 调整 `settings.py` 中的超时参数
3. 优化智能体的提示词长度
4. 使用更快的 OpenAI 模型（如 gpt-3.5-turbo）

#### Q5: 日志文件过大
**问题**: `logs/app.log` 文件占用过多磁盘空间
**解决方案**:
1. 日志自动轮转已配置（10MB，保留5个文件）
2. 手动清理旧日志: `rm logs/app.log.*`
3. 调整日志级别: 将 `LOG_LEVEL` 设置为 `WARNING` 或 `ERROR`
4. 定期清理日志的 cron 任务

### 5.3 维护和扩展建议

#### 代码维护
1. **定期更新依赖**:
   ```bash
   # 检查过时的包
   pip list --outdated
   
   # 更新特定包
   pip install --upgrade <package-name>
   
   # 更新所有包（谨慎使用）
   pip freeze | cut -d'=' -f1 | xargs pip install --upgrade
   ```

2. **代码质量保证**:
   - 使用 `black` 进行代码格式化
   - 使用 `flake8` 进行代码风格检查
   - 编写单元测试覆盖核心功能
   - 定期进行代码审查

3. **性能监控**:
   - 监控 API 响应时间
   - 跟踪智能体处理效率
   - 记录系统资源使用情况
   - 设置告警机制

#### 功能扩展建议
1. **新增智能体类型**:
   - 退款处理智能体
   - 产品推荐智能体
   - 投诉处理智能体

2. **增强数据源**:
   - 连接真实的订单管理系统
   - 集成多个物流服务商API
   - 添加客户历史记录查询

3. **用户界面改进**:
   - 开发 Web 界面
   - 添加语音交互功能
   - 支持多语言界面

4. **智能化提升**:
   - 实现智能体学习机制
   - 添加情感分析功能
   - 支持上下文记忆

#### 安全性考虑
1. **API 安全**:
   - 实现 API 密钥轮换
   - 添加请求频率限制
   - 使用 HTTPS 加密通信

2. **数据保护**:
   - 敏感信息脱敏处理
   - 实现数据加密存储
   - 定期备份重要数据

3. **访问控制**:
   - 实现用户身份验证
   - 添加角色权限管理
   - 记录操作审计日志

#### 扩展性设计
1. **微服务架构**:
   - 将不同功能拆分为独立服务
   - 使用消息队列进行服务间通信
   - 实现服务发现和负载均衡

2. **数据库集成**:
   - 添加持久化存储
   - 实现数据缓存机制
   - 支持分布式数据库

3. **云原生部署**:
   - 容器化部署
   - Kubernetes 编排
   - 自动扩缩容

---

## 附录

### A. 环境变量配置参考
```bash
# OpenAI 配置
OPENAI_API_KEY=sk-your-api-key-here
OPENAI_MODEL=gpt-4o
OPENAI_BASE_URL=https://api.openai.com/v1

# 服务配置
MOCK_SERVER_HOST=127.0.0.1
MOCK_SERVER_PORT=8000

# 重试配置
MAX_RETRIES=3
RETRY_DELAY=1.0
TIMEOUT=30

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log
```

### B. 常用命令速查
```bash
# 项目启动
python main.py --query "订单查询"

# 开发调试
python main.py --log-level DEBUG

# 测试运行
pytest tests/

# 代码格式化
black .

# 依赖管理
pip freeze > requirements.txt
```

### C. 项目贡献指南
1. Fork 项目仓库
2. 创建功能分支: `git checkout -b feature/new-feature`
3. 提交更改: `git commit -am 'Add new feature'`
4. 推送分支: `git push origin feature/new-feature`
5. 创建 Pull Request

---

**文档版本**: v1.0  
**最后更新**: 2024年1月  
**维护者**: AutoGen 多智能体客服系统开发团队  

如有问题或建议，请通过项目 Issues 页面反馈。