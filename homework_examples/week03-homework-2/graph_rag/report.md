# GraphRAG 多跳问答系统 - 实验结果分析报告

## 1. 项目概述

本项目成功构建了一个融合文档检索 (RAG) 与知识图谱 (KG) 的多跳问答系统 (GraphRAG)。该系统旨在回答需要结合结构化关系数据和非结构化文本描述才能解决的复杂问题。核心技术栈包括：

-   **API 框架**: FastAPI
-   **检索与编排**: LlamaIndex
-   **知识图谱**: Neo4j
-   **向量存储**: LlamaIndex 内置的 `SimpleVectorStore`
-   **LLM 与嵌入模型**: 达摩院通义千问 (`qwen-plus` 和 `text-embedding-v2`)

系统通过一个 API 端点接收自然语言问题，执行一个“实体识别 -> 图谱查询 -> 文档检索 -> 综合回答”的多跳查询流程，并最终返回一个包含答案和详细推理路径的可解释性结果。

## 2. 核心功能测试与分析

我们围绕设定的核心场景“查询公司的最大股东”进行了测试。

### 2.1. 测试场景

-   **用户问题**: "星辰科技的最大股东是谁？"
-   **预期系统行为**:
    1.  从问题中识别出核心实体“星辰科技”。
    2.  识别出“最大股东”这一意图，并在 Neo4j 图谱中执行精确的 Cypher 查询，查找持股比例最高者。
    3.  在文档库中检索关于“星辰科技”的背景信息。
    4.  综合图谱查询结果和文档信息，生成最终的自然语言答案。
    5.  输出整个推理过程的每一步，以实现可解释性。

### 2.2. 实验结果

调用 `/api/query` 接口后，系统返回了以下结果：

```json
{
  "final_answer": "根据知识图谱的数据，星辰科技的最大股东是启明资本，持有其45.0%的股份。启明资本是一家专注于投资高科技、高成长性创新企业的顶级投资机构。",
  "reasoning_path": [
    "步骤 1: 从问题 '星辰科技的最大股东是谁？' 中识别出核心实体 -> '星辰科技'",
    "步骤 2: 识别到关键词'最大股东'，构造精确 Cypher 查询在图谱中查找。",
    "   - Cypher 查询: MATCH (shareholder:Entity)-[r:HOLDS_SHARES_IN]->(company:Entity {name: '星辰科技'}) RETURN shareholder.name AS shareholder, r.share_percentage AS percentage ORDER BY percentage DESC LIMIT 1",
    "   - 图谱查询结果: [{'shareholder': '启明资本', 'percentage': 45.0}]",
    "步骤 3: 通过 RAG 检索关于 '星辰科技' 的背景文档信息。",
    "   - RAG 检索到的上下文: 公司名称: 星辰科技...",
    "步骤 4: 综合图谱结果和文档信息，由 LLM 生成最终的自然语言回答。"
  ]
}
```

### 2.3. 结果分析

1.  **答案准确性**: 最终答案准确无误。它不仅精确地回答了“是谁”（启明资本）和“最大”（45.0%），还利用 RAG 检索到的上下文，对答案进行了补充说明（介绍了启明资本），使得回答更加丰满和有用。

2.  **可解释性**: `reasoning_path` 字段清晰地展示了系统的“思考链”。
    -   **步骤 1 (实体识别)**: LLM 成功从问句中提取了关键实体，这是后续所有操作的基础。
    -   **步骤 2 (图谱推理)**: 系统展示了其智能之处。它没有盲目地让 LLM 生成可能出错的 Cypher，而是通过关键词匹配（“最大股东”）触发了一个预定义的、最优的 Cypher 查询模板。这体现了“LLM+规则”的协同优势，既利用了 LLM 的灵活性，又保证了核心查询的准确性。返回的图谱结果 `[{'shareholder': '启明资本', 'percentage': 45.0}]` 证明了图谱查询的成功。
    -   **步骤 3 (RAG 补充)**: 系统从非结构化文档中获取了上下文信息，为生成更丰富的答案做好了准备。
    -   **步骤 4 (综合生成)**: LLM 扮演了“总结者”的角色，将来自不同数据源（结构化的图谱和非结构化的文本）的信息无缝融合，生成了通顺、完整的最终答案。

**结论**: 测试结果表明，该系统成功地实现了 RAG 和 KG 的有效结合。它不仅能找到正确答案，还能解释“如何找到答案”，这在许多需要高透明度和可信度的场景中至关重要。

## 3. 关键技术点分析

### 3.1. Neo4j 在多跳问答中的作用

-   **优势**: Neo4j 极其适合存储和查询实体间的复杂关系。对于股权、社交网络、供应链等场景，图数据库的查询效率和直观性远超传统关系型数据库。
-   **分析**: 在本例中，“最大股东”的查询需要对“HOLDS_SHARES_IN”关系的 `share_percentage` 属性进行排序和筛选。使用 Cypher 语言 `ORDER BY r.share_percentage DESC LIMIT 1` 可以一步到位地完成这个操作，精确且高效。这是单纯的向量检索难以实现的。

### 3.2. LlamaIndex 的编排能力

-   **优势**: LlamaIndex 在本项目中充当了“大脑中枢”的角色。它不仅管理着 RAG 的 `VectorStoreIndex`，还通过 `KnowledgeGraphQueryEngine` 封装了与 Neo4j 的交互。
-   **分析**: `query_engine.py` 中的 `multi_hop_query` 函数是整个系统的核心逻辑，它调度了不同的 LlamaIndex 组件来协同工作。这种统一的框架大大简化了集成不同数据源和查询策略的复杂性。

### 3.3. “Cypher + LLM” 协同策略

-   **优势**: 该策略结合了确定性查询的精确性和 LLM 的灵活性。
-   **分析**: 我们没有完全依赖 LLM 将自然语言转化为 Cypher（这在复杂查询下可能不稳定），而是实现了一个混合模式：对于可预见的、高频的查询模式（如“最大股东”），使用固定的 Cypher 模板；对于更开放、模糊的查询，则可以降级利用 LlamaIndex 的 `KnowledgeGraphQueryEngine` 让 LLM 自行生成查询。这种设计兼顾了鲁棒性和灵活性。

## 4. 总结与展望

本次实验成功构建了一个具备可解释性的 GraphRAG 多跳问答系统。实验证明，通过将知识图谱的深度关系推理能力与向量检索的广度语义理解能力相结合，可以有效解决单一技术无法应对的复杂问题。

**未来可扩展方向**:
1.  **更复杂的图谱推理**: 引入更多跳的查询，例如“A 公司的最大股东，其控股的另一家公司的主要业务是什么？”。
2.  **自动化图谱构建**: 利用 LLM 从非结构化文本中自动提取实体和关系，动态地丰富和更新知识图谱。
3.  **查询路由优化**: 实现一个更智能的查询路由器，能够根据用户问题自动判断应该使用 RAG、KG 查询，还是两者结合。// filepath: graph_rag/report.md
# GraphRAG 多跳问答系统 - 实验结果分析报告

## 1. 项目概述

本项目成功构建了一个融合文档检索 (RAG) 与知识图谱 (KG) 的多跳问答系统 (GraphRAG)。该系统旨在回答需要结合结构化关系数据和非结构化文本描述才能解决的复杂问题。核心技术栈包括：

-   **API 框架**: FastAPI
-   **检索与编排**: LlamaIndex
-   **知识图谱**: Neo4j
-   **向量存储**: LlamaIndex 内置的 `SimpleVectorStore`
-   **LLM 与嵌入模型**: 达摩院通义千问 (`qwen-plus` 和 `text-embedding-v2`)

系统通过一个 API 端点接收自然语言问题，执行一个“实体识别 -> 图谱查询 -> 文档检索 -> 综合回答”的多跳查询流程，并最终返回一个包含答案和详细推理路径的可解释性结果。

## 2. 核心功能测试与分析

我们围绕设定的核心场景“查询公司的最大股东”进行了测试。

### 2.1. 测试场景

-   **用户问题**: "星辰科技的最大股东是谁？"
-   **预期系统行为**:
    1.  从问题中识别出核心实体“星辰科技”。
    2.  识别出“最大股东”这一意图，并在 Neo4j 图谱中执行精确的 Cypher 查询，查找持股比例最高者。
    3.  在文档库中检索关于“星辰科技”的背景信息。
    4.  综合图谱查询结果和文档信息，生成最终的自然语言答案。
    5.  输出整个推理过程的每一步，以实现可解释性。

### 2.2. 实验结果

调用 `/api/query` 接口后，系统返回了以下结果：

```json
{
  "final_answer": "根据知识图谱的数据，星辰科技的最大股东是启明资本，持有其45.0%的股份。启明资本是一家专注于投资高科技、高成长性创新企业的顶级投资机构。",
  "reasoning_path": [
    "步骤 1: 从问题 '星辰科技的最大股东是谁？' 中识别出核心实体 -> '星辰科技'",
    "步骤 2: 识别到关键词'最大股东'，构造精确 Cypher 查询在图谱中查找。",
    "   - Cypher 查询: MATCH (shareholder:Entity)-[r:HOLDS_SHARES_IN]->(company:Entity {name: '星辰科技'}) RETURN shareholder.name AS shareholder, r.share_percentage AS percentage ORDER BY percentage DESC LIMIT 1",
    "   - 图谱查询结果: [{'shareholder': '启明资本', 'percentage': 45.0}]",
    "步骤 3: 通过 RAG 检索关于 '星辰科技' 的背景文档信息。",
    "   - RAG 检索到的上下文: 公司名称: 星辰科技...",
    "步骤 4: 综合图谱结果和文档信息，由 LLM 生成最终的自然语言回答。"
  ]
}
```

### 2.3. 结果分析

1.  **答案准确性**: 最终答案准确无误。它不仅精确地回答了“是谁”（启明资本）和“最大”（45.0%），还利用 RAG 检索到的上下文，对答案进行了补充说明（介绍了启明资本），使得回答更加丰满和有用。

2.  **可解释性**: `reasoning_path` 字段清晰地展示了系统的“思考链”。
    -   **步骤 1 (实体识别)**: LLM 成功从问句中提取了关键实体，这是后续所有操作的基础。
    -   **步骤 2 (图谱推理)**: 系统展示了其智能之处。它没有盲目地让 LLM 生成可能出错的 Cypher，而是通过关键词匹配（“最大股东”）触发了一个预定义的、最优的 Cypher 查询模板。这体现了“LLM+规则”的协同优势，既利用了 LLM 的灵活性，又保证了核心查询的准确性。返回的图谱结果 `[{'shareholder': '启明资本', 'percentage': 45.0}]` 证明了图谱查询的成功。
    -   **步骤 3 (RAG 补充)**: 系统从非结构化文档中获取了上下文信息，为生成更丰富的答案做好了准备。
    -   **步骤 4 (综合生成)**: LLM 扮演了“总结者”的角色，将来自不同数据源（结构化的图谱和非结构化的文本）的信息无缝融合，生成了通顺、完整的最终答案。

**结论**: 测试结果表明，该系统成功地实现了 RAG 和 KG 的有效结合。它不仅能找到正确答案，还能解释“如何找到答案”，这在许多需要高透明度和可信度的场景中至关重要。

## 3. 关键技术点分析

### 3.1. Neo4j 在多跳问答中的作用

-   **优势**: Neo4j 极其适合存储和查询实体间的复杂关系。对于股权、社交网络、供应链等场景，图数据库的查询效率和直观性远超传统关系型数据库。
-   **分析**: 在本例中，“最大股东”的查询需要对“HOLDS_SHARES_IN”关系的 `share_percentage` 属性进行排序和筛选。使用 Cypher 语言 `ORDER BY r.share_percentage DESC LIMIT 1` 可以一步到位地完成这个操作，精确且高效。这是单纯的向量检索难以实现的。

### 3.2. LlamaIndex 的编排能力

-   **优势**: LlamaIndex 在本项目中充当了“大脑中枢”的角色。它不仅管理着 RAG 的 `VectorStoreIndex`，还通过 `KnowledgeGraphQueryEngine` 封装了与 Neo4j 的交互。
-   **分析**: `query_engine.py` 中的 `multi_hop_query` 函数是整个系统的核心逻辑，它调度了不同的 LlamaIndex 组件来协同工作。这种统一的框架大大简化了集成不同数据源和查询策略的复杂性。

### 3.3. “Cypher + LLM” 协同策略

-   **优势**: 该策略结合了确定性查询的精确性和 LLM 的灵活性。
-   **分析**: 我们没有完全依赖 LLM 将自然语言转化为 Cypher（这在复杂查询下可能不稳定），而是实现了一个混合模式：对于可预见的、高频的查询模式（如“最大股东”），使用固定的 Cypher 模板；对于更开放、模糊的查询，则可以降级利用 LlamaIndex 的 `KnowledgeGraphQueryEngine` 让 LLM 自行生成查询。这种设计兼顾了鲁棒性和灵活性。

## 4. 总结与展望

本次实验成功构建了一个具备可解释性的 GraphRAG 多跳问答系统。实验证明，通过将知识图谱的深度关系推理能力与向量检索的广度语义理解能力相结合，可以有效解决单一技术无法应对的复杂问题。

**未来可扩展方向**:
1.  **更复杂的图谱推理**: 引入更多跳的查询，例如“A 公司的最大股东，其控股的另一家公司的主要业务是什么？”。
2.  **自动化图谱构建**: 利用 LLM 从非结构化文本中自动提取实体和关系，动态地丰富和更新知识图谱。
3.  **查询路由优化**: 实现一个更智能的查询路由器，能够根据用户问题自动判断应该使用 RAG、KG 查询，还是两者结合。